# RPC

## 1. IPC

IPC（Inter Process Communication）：进程间通信，不同的进程之间传播或传输信息，例如将一张图片从微信发送到QQ。

可以通过两个维度区分进程间通信：

1、从进程的通信方式区分：

- **管道**（Pipe）：类似于两个进程间的桥梁，两个进程在这座桥梁传输少量的字符

  - 普通管道：父进程fork子进程后，两个具有亲缘关系的进程通过打开的管道文件通信
  - 具名管道：允许不具有亲缘关系的进程通信

  ~~~bash
  ps - ef | grep java
  ~~~

  `ps`和`grep`是两个不同的进程，通过管道操作符 '|' 连接

- **信号**（Signal）：信号用于通知某个进程有某种事件发生，信号的典型应用是 kill

  ~~~bash
  kill -9 pid
  ~~~

  Shell进程向指定pid的进程发送SIGKILL信号

- **信号量**（Semaphore）：两个进程之间的同步协作机制，相当于一个特殊变量，程序可以在上面进行wait和notify

- **消息队列**（Message Queue）：<font color=red>以上三种方式只适合传输少量数据。</font>消息队列可以实现较大数据量的传输

- **共享内存**（Shared Memory）：允许多个进程访问同一块公共内存空间，效率最高的进程通信方式。当一块内存被共享时，各个进程需要使用通信机制，譬如与信号量结合使用，来达到进程间的同步及互斥的协调操作。

- **本地套接字通信**（Socket）：<font color=red>以上两种方式只能单机多进程的通信。</font>本地套接字则是普适的进程间通信方式，可用于**不同机器之间**的进程通信

2、从两个进程的位置区分：

- 本地过程调用（LPC）：同一台机器的进程间的通信
- 远程过程调用（RPC）：不同机器的进程间的通信

## 2. RPC

RPC（Remote Procedure Call：远程过程调用）是实现跨机器进程间通信的协议，可以基于HTTP实现（gRPC），也可以基于TCP实现(dubbo)。

在一台机器上的主进程，可以调用另一台机器上准备好的进程，就如同LPC一样。RPC模型试图使远程网络服务看起来像进程在调用本地方法一样，实际上RPC与LPC存在着巨大的差距：

- 跨机器的进程通信收到了网络的巨大影响，在不同的网络情况下，请求的时间也不尽相同。

- 本地函数调用要么返回结果，要么抛出异常，要么不返回结果。但网络调用还可能因为网络原因超时，因此进程在收不到响应时根本不知道发生了什么。
- 如果请求超时，客户端会选择重新发送该请求，这就需要保证重复请求的幂等性。本地函数调用不会出现这种问题。

例如：一台机器的某个服务例如`orderservice`想要调用另一台机器的某个服务`userservice`

<img src="https://raw.githubusercontent.com/Leibgo/Pic/main/img/202205221537824.png" alt="image-20220522153705732" style="zoom:80%;float:left" />

由于两个进程位于不同的机器，一次需要通过网络来传输调用的数据，那么也随之带来的问题是：网络是不可靠的。程序员无法确保网络始终是可靠的，因此RPC跨机器的进程通信的效率是不可能比LPC的效率高。

一个实现RPC协议的框架需要解决三个问题：

- 数据交换的格式
- 数据传输的协议
- 服务的发现

### 2.1 数据交换的格式

> 传统的C/S前后端分离开发中，Vue使用JavaScipt编程语言，Spring使用Java编程语言，不同的编程语言是如何实现数据传输的呢？
>
> - 前后端的数据交互使用JSON（字节序列）实现
> - 前端将JS对象转换成JSON，通过HTTP协议（URL）发送到后端
> - 后端将JSON对象转换成JAVA对象
>
> RESTful不是RPC框架，但体现了RPC的思想。RESTful是面向资源的URL约定，基于HTTP和JSON序列化文本实现

数据指的是传递给方法的参数以及方法执行后的返回值。无论是将参数传给另一个进程，还是从另一个进程取回执行结果，都涉及数据格式问题。有效的做法是交互双方交换的数据转换成事先约定好的中立数据格式来进行传输，将数据流转换回不同语言的数据类型类使用（序列化机制）。

数据格式可以大体分为两种：

- 基于文本的数据格式：
  - JSON、XML这种可读性强的文本数据，但数据量大，冗余

- 二进制数据格式：
  - Protocol Buffers
  - Avro

如果双方通信的数据量大，建议使用二进制数据格式作为序列化机制

### 2.2 数据传输的协议

两个服务交互不是扔个序列化机制来表示参数和结果就行，许多除此之外的信息，譬如异常、超时、安全、授权、事务等，都可能产生双方需要交换信息的需求、。

不同的RPC框架拥有不同的数据传输协议，可以基于HTTP协议实现（gRPC），也可以基于TCP传输层协议实现（Dubbo）。

### 2.3 方法的发现

相比于单体架构，并没有一种简单的编程语言结构可以构造和定义服务的API。使用IDL精确定义服务的API都很重要。

> IDL：接口描述语言。通过一种中立的方式来描述接口，使得不同平台上运行的对象和不同语言编写的程序可以通信交流。

前后端开发时：

- 首先编写接口定义
- 与客户端人员查看接口定义
- 反复迭代后，开始具体的服务实现编程

如果使用HTTP：则API由URL、HTTP动词以及请求和响应格式组成